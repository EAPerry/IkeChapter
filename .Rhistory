#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
plot_slopes(intdid[[1]],
conf_level = .95,
vcov = ~FIPS,
variables = "ATT",
condition = "log_fixedcont") +
labs(x = "Log of 2007 Contributions",
y = "Average change in log(Output)")
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Plot the marginal effects-----------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
plot_slopes(intdid[[1]],
#conf_level = .95,
vcov = ~FIPS,
variables = "ATT",
condition = "log_fixedcont") +
labs(x = "Log of 2007 Contributions",
y = "Average change in log(Output)")
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Plot the marginal effects-----------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
slopes(intdid[[1]], variables = "ATT", vcov = ~FIPS)
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Plot the marginal effects-----------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
slopes(intdid[[1]], variables = "ATT")
# Run the regression of choice
my_reg <- function(outcome, rhs, fe, sample_df){
f = as.formula(paste(outcome, '~', rhs, "|", fe))
reg_results = feols(f, sample_df)
return(reg_results)
}
intdid <- my_table(
rhs = "ATT:log_fixedcont + ATT + treatment + post + log_fixedcont",
fe = "as.factor(year) + as.factor(FIPS)",
sample_df = df %>% filter(is.finite(log_fixedcont)),
filename = "Results/Regression Tables/eap_thru_2007cont.tex",
title = "Heterogenous Effects Through Contributions"
)
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Plot the marginal effects-----------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
slopes(intdid[[1]], variables = "ATT")
# Run the regression of choice
my_reg <- function(outcome, rhs, fe, sample_df){
f = as.formula(paste(outcome, '~', rhs, "|", fe))
reg_results = feols(f, sample_df, ~FIPS)
return(reg_results)
}
intdid <- my_table(
rhs = "ATT:log_fixedcont + ATT + treatment + post + log_fixedcont",
fe = "as.factor(year) + as.factor(FIPS)",
sample_df = df %>% filter(is.finite(log_fixedcont)),
filename = "Results/Regression Tables/eap_thru_2007cont.tex",
title = "Heterogenous Effects Through Contributions"
)
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Plot the marginal effects-----------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#Automatically clusters se by FIPS because that's built into model estimation
plot_slopes(intdid[[1]],
vcov = ~FIPS,
variables = "ATT",
condition = "log_fixedcont") +
labs(x = "Log of 2007 Contributions",
y = "Average change in log(Output)")
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Plot the marginal effects-----------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#Automatically clusters se by FIPS because that's built into model estimation
plot_slopes(intdid[[1]],
variables = "ATT",
condition = "log_fixedcont") +
labs(x = "Log of 2007 Contributions",
y = "Average change in log(Output)")
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Plot the marginal effects-----------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#Automatically clusters se by FIPS because that's built into model estimation
plot_slopes(intdid[[1]],
variables = "ATT",
condition = "log_fixedcont") +
scale_x_continuous(trans = "log10")
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Plot the marginal effects-----------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#Automatically clusters se by FIPS because that's built into model estimation
plot_slopes(intdid[[1]],
variables = "ATT",
condition = "log_fixedcont") +
#scale_x_continuous(trans = "log10")
labs(x = "Log of 2007 Contributions",
y = "Average change in log(Output)")
?log
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Plot the marginal effects-----------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#Automatically clusters se by FIPS because that's built into model estimation
plot_slopes(intdid[[1]],
variables = "ATT",
condition = "log_fixedcont") +
scale_x_continuous(trans = "log")
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Plot the marginal effects-----------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#Automatically clusters se by FIPS because that's built into model estimation
plot_slopes(intdid[[1]],
variables = "ATT",
condition = "log_fixedcont") +
scale_x_continuous(trans = "identity")
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Plot the marginal effects-----------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#Automatically clusters se by FIPS because that's built into model estimation
plot_slopes(intdid[[1]],
variables = "ATT",
condition = "log_fixedcont") +
coord_trans(x = 'identity', y = 'identity')
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Plot the marginal effects-----------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#Automatically clusters se by FIPS because that's built into model estimation
plot_slopes(intdid[[1]],
variables = "ATT",
condition = "log_fixedcont") +
labs(x = "Log of 2007 Contributions",
y = "Average change in log(Output)")
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Plot the marginal effects-----------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#Automatically clusters se by FIPS because that's built into model estimation
plot_slopes(intdid[[1]],
variables = "ATT",
condition = "log_fixedcont") +
labs(x = "Log of 2007 Contributions",
y = "Average change in log(Output)") +
theme_bw()
slp2 <- plot_slopes(intdid[[2]],
variables = "ATT",
condition = "log_fixedcont") +
labs(x = "Log of 2007 Contributions",
y = "Average change in log(Density)") +
theme_bw()
slp2
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Plot the marginal effects-----------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#Automatically clusters se by FIPS because that's built into model estimation
slp1 <- plot_slopes(intdid[[1]],
variables = "ATT",
condition = "log_fixedcont") +
labs(x = "Log of 2007 Contributions",
y = "Average change in log(Output)") +
theme_bw() +
geom_hline(yintercept = 0)
slp2 <- plot_slopes(intdid[[2]],
variables = "ATT",
condition = "log_fixedcont") +
labs(x = "Log of 2007 Contributions",
y = "Average change in log(Density)") +
theme_bw() +
geom_hline(yintercept = 0)
slp3 <- plot_slopes(intdid[[3]],
variables = "ATT",
condition = "log_fixedcont") +
labs(x = "Log of 2007 Contributions",
y = "Average change in Resource Dependence") +
theme_bw() +
geom_hline(yintercept = 0)
ggarrange(slp1, slp2, slp3, nrow = 1)
ggarrange(slp1, slp2, slp3, nrow = 3)
ggarrange(slp1, slp2, slp3, nrow = 3) + ggtitle("Average Changes in Nonprofit Indicators Post-Hurricane by Scale of Pre-Disaster GC")
print(ggarrange(slp1, slp2, slp3, nrow = 3) +
ggtitle("Average Changes in Nonprofit Indicators Post-Hurricane by Scale of Pre-Disaster GC"))
print(ggarrange(slp1, slp2, slp3, nrow = 3) +
labs(title = "Average Changes in Nonprofit Indicators Post-Hurricane by Scale of Pre-Disaster GC"))
slopesplot <- ggarrange(slp1, slp2, slp3, nrow = 3)
annotate_figure(slopesplot,
top = text_grob("Average Changes in Nonprofit Indicators Post-Hurricane by Scale of Pre-Disaster GC",
face = "bold", size = 14))
library(tidyverse)
library(lubridate)
library(arrow)
library(fastDummies)
library(callr)
# Spatial
library(sf)
library(tidycensus)
library(tmap)
library(tmaptools)
# Estimation
library(fixest)
library(marginaleffects)
# Aesthetics
library(stargazer)
library(ggpubr)
library(NatParksPalettes)
df <- read_csv('Results/cleaned_filtered_data.csv')
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#Update yvars for final outputs
yvars <- c("output", "density")
# # Run regressions for each of the outcome variables in "yvars"
# firstModels <- lapply(yvars, function(x){
#   lm(formula =
#        paste0("log(`", x, "`) ~ treatment*post + as.factor(year) + as.factor(FIPS)"),
#      data = df)
# })
#
# firstModels[[length(firstModels)+1]] <-
#   lm(dependence ~ treatment*post + as.factor(year) + as.factor(FIPS),
#      data = df)
#
# names(firstModels) <- c(yvars, "dependence") #label ea. regression by yvar
#
#
#
# # Store clustered SEs
# firstSE <- lapply(firstModels, do_the_SE)
#
# #Save regression table
# stargazer(firstModels,
#           title = "Preliminary Difference-in-Differences",
#           omit = c("factor","Constant"),
#           se = firstSE,
#           type = "latex",
#           order = c(
#             "treatment:post",
#             "treatment",
#             "post"
#           ),
#           font.size = 'small',
#           covariate.labels = c(
#             "Disaster * Post Storm",
#             "Disaster",
#             "Post Storm"
#           ),
#           dep.var.labels.include = F,
#           column.labels = c(yvars, "dependence"),
#           omit.stat = c("rsq", "adj.rsq"),
#           out = "Results/Regression Tables/blj_reg1.tex")
#
# #:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#
#
# #:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#
# # Run regressions for each of the outcome variables in "yvars"
# secondModels <- lapply(yvars, function(x){
#   lm(formula =
#        paste0("log(`", x, "`) ~ treatment:post:log(fixedcont) + treatment*post +
#               log(fixedcont) + as.factor(year) + as.factor(FIPS)"),
#      data = df[is.finite(log(df$fixedcont)),])
# })
#
# secondModels[[length(secondModels)+1]] <- lm(
#   dependence ~ treatment:post:log(fixedcont) + treatment*post + log(fixedcont) +
#     as.factor(year) + as.factor(FIPS),
#   data = df[is.finite(log(df$fixedcont)),])
#
# names(secondModels) <- c(yvars, "dependence") #label ea. regression by yvar
#
# # Store clustered SEs
# secondSE <- lapply(secondModels, do_the_SE)
#
# #Save regression table
# stargazer(secondModels,
#           title = "Heterogeneous Effects Through Pre-Disaster Contributions",
#           omit = c("factor","Constant"),
#           se = secondSE,
#           type = "latex",
#           order = c(
#             "treatment:post:log(fixedcont)",
#             "treatment:post",
#             "treatment",
#             "post",
#             "log(fixedcont)"
#           ),
#           font.size = 'small',
#           covariate.labels = c(
#             "Disaster * Post Storm * Log 2007 Cont.",
#             "Disaster * Post Storm",
#             "Disaster",
#             "Post Storm",
#             "Log 2007 Cont."
#           ),
#           dep.var.labels.include = F,
#           column.labels = c(yvars, "dependence"),
#           omit.stat = c("rsq", "adj.rsq"),
#           out = "Results/Regression Tables/blj_reg2.tex")
#
# #:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#
#
# #:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#
# # Run regressions for each of the outcome variables in "yvars"
# thirdModels <- lapply(yvars, function(x){
#   lm(formula =
#        paste0("log(`", x, "`) ~ treatment:post:tpost + treatment*post +
#                tpost + as.factor(year) + as.factor(FIPS)"),
#      data = df)
# })
#
# thirdModels[[length(thirdModels)+1]] <-
#   lm(dependence ~ treatment:post:tpost + treatment*post + tpost +
#        as.factor(year) + as.factor(FIPS), data = df)
#
# names(thirdModels) <- c(yvars, "dependence") #label ea. regression by yvar
#
# # Store clustered SEs
# thirdSE <- lapply(thirdModels, do_the_SE)
#
# #Save regression table
# stargazer(thirdModels,
#           title = "Differences-in-Differences with Dynamic Effects",
#           omit = c("factor","Constant"),
#           se = thirdSE,
#           type = "latex",
#           order = c(
#             "treatment:post:tpost",
#             "treatment:post",
#             "treatment",
#             "post",
#             "tpost"
#           ),
#           font.size = 'small',
#           covariate.labels = c(
#             "Disaster * Post Storm * Years After",
#             "Disaster * Post Storm",
#             "Disaster",
#             "Post Storm",
#             "Years After"
#           ),
#           dep.var.labels.include = F,
#           column.labels = c(yvars, "dependence"),
#           omit.stat = c("rsq", "adj.rsq"),
#           out = "Results/Regression Tables/blj_reg3.tex")
#
# #:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#
#
#
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Helper Functions -------------------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Run the regression of choice
my_reg <- function(outcome, rhs, fe, sample_df){
f = as.formula(paste(outcome, '~', rhs, "|", fe))
reg_results = feols(f, sample_df, ~FIPS)
return(reg_results)
}
# Make a proper table
my_table <- function(rhs, fe, sample_df, filename, title) {
outcome_list <- list("log_output","log_density","dependence")
all_models <- lapply(outcome_list, function (x) my_reg(x , rhs, fe, sample_df))
unlink(filename)
etable(all_models,
vcov = "hc1",
tex = T,
title = title,
file = filename,
dict = var_labs,
order = c("Disaster", "Post", "log GC"),
adjustbox = "max width = \\textwidth, center"
)
return(all_models)
}
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Read in and final data prep --------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
df <- read_csv('Results/cleaned_filtered_data.csv')
# Give some log transforms to the data (a little treat)
df <- df %>%
mutate(
log_output = log(output),
log_density = log(density),
log_fixedcont = log(fixedcont),
log_pop = log(pop),
ATT = post*treatment              #specify ATT for marginal effects plotting
)
# And make a little data dictionary
var_labs <- c(
`as.factor(year)` = "Year",
`as.factor(FIPS)` = "County",
treatment = "Disaster",
post = "Post",
tpost = "Years Post",
log_fixedcont = "log GC$_{2007}$",
log_output = "log Output",
log_density = "log Density",
dependence = "Dependence",
log_pop = "log Population",
ATT = "average treatment effect on the treated"
)
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Basic DiD --------------------------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
basicdid <- my_table(
rhs = "ATT + post + treatment",
fe = "as.factor(year) + as.factor(FIPS)",
sample_df = df,
filename = "Results/Regression Tables/eap_baseline.tex",
title = "Baseline Difference-in-Differences"
)
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Interaction with GC Scale ----------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
intdid <- my_table(
rhs = "ATT:log_fixedcont + ATT + treatment + post + log_fixedcont",
fe = "as.factor(year) + as.factor(FIPS)",
sample_df = df %>% filter(is.finite(log_fixedcont)),
filename = "Results/Regression Tables/eap_thru_2007cont.tex",
title = "Heterogenous Effects Through Contributions"
)
summary(basicdid[[1]])
summary(basicdid[[2]])
summary(basicdid[[3]])
summary(intdid[[1]])
summary(intdid[[2]])
summary(intdid[[3]])
# Run the regression of choice
my_reg <- function(outcome, rhs, fe, sample_df){
f = as.formula(paste(outcome, '~', rhs, "|", fe))
reg_results = feols(f, sample_df, vcov = "hc1")
return(reg_results)
}
# Make a proper table
my_table <- function(rhs, fe, sample_df, filename, title) {
outcome_list <- list("log_output","log_density","dependence")
all_models <- lapply(outcome_list, function (x) my_reg(x , rhs, fe, sample_df))
unlink(filename)
etable(all_models,
vcov = "hc1",
tex = T,
title = title,
file = filename,
dict = var_labs,
order = c("Disaster", "Post", "log GC"),
adjustbox = "max width = \\textwidth, center"
)
return(all_models)
}
df <- read_csv('Results/cleaned_filtered_data.csv')
# Give some log transforms to the data (a little treat)
df <- df %>%
mutate(
log_output = log(output),
log_density = log(density),
log_fixedcont = log(fixedcont),
log_pop = log(pop),
ATT = post*treatment              #specify ATT for marginal effects plotting
)
# And make a little data dictionary
var_labs <- c(
`as.factor(year)` = "Year",
`as.factor(FIPS)` = "County",
treatment = "Disaster",
post = "Post",
tpost = "Years Post",
log_fixedcont = "log GC$_{2007}$",
log_output = "log Output",
log_density = "log Density",
dependence = "Dependence",
log_pop = "log Population",
ATT = "average treatment effect on the treated"
)
basicdid <- my_table(
rhs = "ATT + post + treatment",
fe = "as.factor(year) + as.factor(FIPS)",
sample_df = df,
filename = "Results/Regression Tables/eap_baseline.tex",
title = "Baseline Difference-in-Differences"
)
intdid <- my_table(
rhs = "ATT:log_fixedcont + ATT + treatment + post + log_fixedcont",
fe = "as.factor(year) + as.factor(FIPS)",
sample_df = df %>% filter(is.finite(log_fixedcont)),
filename = "Results/Regression Tables/eap_thru_2007cont.tex",
title = "Heterogenous Effects Through Contributions"
)
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# Plot the marginal effects-----------------------------------------------------
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#Automatically clusters se by FIPS because that's built into model estimation
slp1 <- plot_slopes(intdid[[1]],
variables = "ATT",
condition = "log_fixedcont") +
labs(x = "Log of 2007 Contributions",
y = "Average change in log(Output)") +
theme_bw() +
geom_hline(yintercept = 0)
slp2 <- plot_slopes(intdid[[2]],
variables = "ATT",
condition = "log_fixedcont") +
labs(x = "Log of 2007 Contributions",
y = "Average change in log(Density)") +
theme_bw() +
geom_hline(yintercept = 0)
slp3 <- plot_slopes(intdid[[3]],
variables = "ATT",
condition = "log_fixedcont") +
labs(x = "Log of 2007 Contributions",
y = "Average change in Resource Dependence") +
theme_bw() +
geom_hline(yintercept = 0)
slopesplot <- ggarrange(slp1, slp2, slp3, nrow = 3)
annotate_figure(slopesplot,
top = text_grob("Average Changes in Nonprofit Indicators Post-Hurricane by Scale of Pre-Disaster GC",
face = "bold", size = 14))
